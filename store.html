<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Store Details | Veritas</title>
    <link rel="stylesheet" href="style.css"><script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
</head>
<body class="bg-[var(--bg-main)]">
    <div id="header-root"></div>
    <main class="max-w-7xl mx-auto px-6 py-20">
        <div class="mb-20">
            <p id="storeCat" class="text-blue-600 font-black uppercase tracking-widest text-[10px] mb-4 italic">---</p>
            <h1 id="storeName" class="text-6xl md:text-8xl font-black italic uppercase tracking-tighter leading-none mb-4">---</h1>
        </div>
        <div class="grid lg:grid-cols-12 gap-16">
            <aside class="lg:col-span-4">
                <div class="card-veritas p-10 sticky top-32">
                    <p class="text-[10px] font-black uppercase opacity-30 mb-8">Scoreboard</p>
                    <h2 id="avgScore" class="text-8xl font-black italic leading-none mb-6">0.0</h2>
                    <p class="text-[10px] font-bold opacity-40 uppercase">Based on <span id="totalLogs">0</span> Blockchain Logs</p>
                </div>
            </aside>
            <section id="reviewsList" class="lg:col-span-8 space-y-8">
                <p class="opacity-30 italic animate-pulse">Scanning ledger...</p>
            </section>
        </div>
    </main>
    <div id="footer-root"></div>
    <script src="app.js"></script><script src="components.js"></script>
    <script>
        async function initPage() {
            if(!regContract) return;
            const id = new URLSearchParams(window.location.search).get('id');
            const b = await regContract.businesses(id);
            document.getElementById('storeName').innerText = b.name;
            document.getElementById('storeCat').innerText = ethers.decodeBytes32String(b.category).replace('_',' ');
            
            const events = await revContract.queryFilter(revContract.filters.ReviewSubmitted(id), -100000);
            const list = document.getElementById('reviewsList');
            list.innerHTML = "";
            let sum = 0;
            events.reverse().forEach(ev => {
                const { rating, content, receiptId } = ev.args;
                sum += Number(rating);
                list.innerHTML += `<div class="p-10 border border-[var(--border)] bg-[var(--card-bg)] rounded-[2.5rem]">
                    <div class="flex justify-between mb-8">
                        <span class="text-blue-600 font-bold">${"â˜…".repeat(rating)}</span>
                        <span class="text-[9px] opacity-20 font-mono">#${receiptId.slice(0,12)}</span>
                    </div>
                    <p class="text-3xl italic font-medium leading-tight">"${sanitize(content)}"</p>
                </div>`;
            });
            document.getElementById('avgScore').innerText = events.length ? (sum/events.length).toFixed(1) : "0.0";
            document.getElementById('totalLogs').innerText = events.length;
        }
    </script>
</body>
</html>
