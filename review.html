<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Secure Review Gate | Veritas</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
</head>
<body class="flex flex-col min-h-screen">
    <div class="nav-container">
        <nav class="max-w-7xl mx-auto p-4 flex justify-between items-center">
            <a href="index.html" class="flex items-center gap-2 font-bold text-blue-600 uppercase">‚Üê Veritas Home</a>
            <button id="darkModeToggle">üåì</button>
        </nav>
    </div>

    <main class="flex-grow flex items-center justify-center px-6 py-20">
        <div id="accessDenied" class="hidden card-veritas max-w-lg w-full text-center border-red-500 shadow-xl shadow-red-500/10">
            <div class="text-6xl mb-6">üö´</div>
            <h2 class="text-3xl font-extrabold mb-4 text-red-600">Access Restricted</h2>
            <p id="denialReason" class="text-gray-500 mb-8 font-medium">Validation failed.</p>
            <a href="index.html" class="btn-outline inline-block w-full">Return to Safety</a>
        </div>

        <div id="connectPrompt" class="hidden card-veritas max-w-lg w-full text-center">
            <div class="text-6xl mb-6">ü¶ä</div>
            <h2 class="text-3xl font-extrabold mb-4">Identity Required</h2>
            <p class="text-gray-500 mb-8 font-medium">To maintain review integrity, you must connect a personal wallet to verify you are a unique human user.</p>
            <button onclick="connectWalletAndCheck()" class="btn-primary w-full py-4 text-lg">Connect Wallet</button>
        </div>

        <div id="reviewForm" class="hidden card-veritas max-w-lg w-full">
            <div class="mb-10 border-b border-[var(--border)] pb-6">
                <span class="bg-green-100 text-green-700 text-[10px] px-2 py-1 rounded-full font-bold uppercase mb-2 inline-block">Gate Passed: Verified Purchase</span>
                <h2 class="text-3xl font-extrabold mb-2 tracking-tight">Post Verified Review</h2>
                <p id="storeInfo" class="text-blue-500 font-bold">Store: Loading...</p>
            </div>

            <label class="block text-xs font-bold uppercase tracking-widest mb-2 opacity-60">Experience Score</label>
            <select id="r" class="mb-6 block w-full">
                <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê Excellent</option>
                <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê Great</option>
                <option value="3">‚≠ê‚≠ê‚≠ê Good</option>
                <option value="2">‚≠ê‚≠ê Poor</option>
                <option value="1">‚≠ê Terrible</option>
            </select>

            <label class="block text-xs font-bold uppercase tracking-widest mb-2 opacity-60">Your Feedback</label>
            <textarea id="msg" placeholder="Share your honest experience..." rows="5" class="mb-8"></textarea>
            
            <button id="btn" onclick="send()" class="btn-primary w-full text-lg py-4">Publish Review</button>
        </div>
    </main>

    <footer class="border-t border-[var(--border)] py-8 bg-[var(--surface)]">
        <div class="max-w-7xl mx-auto px-6 flex justify-between items-center text-[10px] uppercase tracking-widest font-bold opacity-50">
            <div>The White Rabbit bored creation</div>
            <div>Powered by Polkadot paseo testnet</div>
        </div>
    </footer>

    <script src="app.js"></script>
    <script>
        const p = new URLSearchParams(window.location.search);
        const bAddr = p.get('business')?.toLowerCase();
        const rid = p.get('receipt');

        async function connectWalletAndCheck() {
            if(await connectWallet()) {
                location.reload(); // Refresh to re-trigger the gates with connected wallet
            }
        }

        window.onload = async () => {
            // 1. Check for QR Params
            if(!bAddr || !rid) {
                showDenial("Missing Receipt Data. You must scan a valid store QR code to access this page.");
                return;
            }

            // 2. Check for Wallet Connection
            if (typeof window.ethereum === 'undefined') {
                showDenial("MetaMask not found. Please use a Web3 browser to leave a verified review.");
                return;
            }

            const accounts = await window.ethereum.request({ method: 'eth_accounts' });
            if (accounts.length === 0) {
                document.getElementById('connectPrompt').classList.remove('hidden');
                return;
            }

            // 3. Initialize Contract & Gates
            await connectWallet();
            const userAddr = (await signer.getAddress()).toLowerCase();
            const biz = await contract.businesses(bAddr);

            // Gate: Is the Business Registered?
            if(!biz.isActive) {
                showDenial("This store is not registered in our protocol.");
                return;
            }

            // Gate: Is it the Merchant trying to review themselves?
            if(userAddr === bAddr) {
                showDenial("Merchant Protection: You cannot review your own business. Use a different wallet.");
                return;
            }

            // Gate: Is the Receipt ID already used? (On-chain check)
            const receiptHash = ethers.id(rid);
            const isUsed = await contract.usedReceipts(receiptHash);
            if(isUsed) {
                showDenial("This receipt ID has already been used for a review. Every purchase is eligible for exactly one review.");
                return;
            }

            // ALL GATES PASSED
            document.getElementById('reviewForm').classList.remove('hidden');
            document.getElementById('storeInfo').innerText = `Verified for: ${biz.name}`;
        };

        function showDenial(reason) {
            document.getElementById('accessDenied').classList.remove('hidden');
            document.getElementById('denialReason').innerText = reason;
            document.getElementById('reviewForm').classList.add('hidden');
            document.getElementById('connectPrompt').classList.add('hidden');
        }

        async function send() {
            const btn = document.getElementById('btn');
            btn.innerText = "Submitting to Asset Hub...";
            try {
                const tx = await contract.postReview(bAddr, document.getElementById('r').value, document.getElementById('msg').value, ethers.id(rid), "0x");
                await tx.wait();
                window.location.href = `store.html?id=${bAddr}`;
            } catch (e) { 
                alert(e.message); 
                btn.innerText = "Publish Review"; 
            }
        }
    </script>
</body>
</html>
