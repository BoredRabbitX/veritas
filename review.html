<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"><title>Post Review | Veritas</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
</head>
<body>
    <div class="nav-container"><nav class="max-w-7xl mx-auto p-4 flex justify-between items-center"><a href="index.html" class="font-black text-2xl">VERITAS</a><button id="connectBtn" class="btn-primary text-sm" onclick="connectWallet()">Connect</button></nav></div>

    <main class="main-content flex items-center justify-center px-6 py-12">
        <div class="card-veritas max-w-lg w-full">
            <h2 class="text-3xl font-black mb-8">Submit Review</h2>
            <div id="setupData" class="space-y-4 mb-8">
                <input id="bizInput" type="text" placeholder="Merchant Wallet (0x...)">
                <input id="receiptInput" type="text" placeholder="Receipt ID">
                <button onclick="processValidation()" class="btn-primary w-full">Verify Purchase</button>
            </div>
            <div id="form" class="hidden space-y-6">
                <p id="storeName" class="text-blue-600 font-bold"></p>
                <input id="custName" type="text" placeholder="Your Name">
                <select id="rating"><option value="5">⭐⭐⭐⭐⭐ Excellent</option><option value="4">⭐⭐⭐⭐ Great</option><option value="3">⭐⭐⭐ Good</option><option value="2">⭐⭐ Poor</option><option value="1">⭐ Terrible</option></select>
                <textarea id="comment" placeholder="Describe your experience..." rows="4"></textarea>
                <button id="submitBtn" onclick="send()" class="btn-primary w-full py-4">Publish On-Chain</button>
            </div>
        </div>
    </main>
    <script src="app.js"></script>
    <script>
        const p = new URLSearchParams(window.location.search);
        window.onload = () => {
            if(p.get('business')) document.getElementById('bizInput').value = p.get('business');
            if(p.get('receipt')) document.getElementById('receiptInput').value = p.get('receipt');
        };
        async function processValidation() {
            const bA = document.getElementById('bizInput').value;
            if(!contract) await connectWallet();
            const b = await contract.businesses(bA);
            if(b.isActive) {
                document.getElementById('setupData').classList.add('hidden');
                document.getElementById('form').classList.remove('hidden');
                document.getElementById('storeName').innerText = "Reviewing: " + b.name;
            } else { alert("Store not found."); }
        }
        async function send() {
            const btn = document.getElementById('submitBtn');
            btn.disabled = true; btn.innerText = "Confirming...";
            try {
                const tx = await contract.postReview(document.getElementById('bizInput').value, document.getElementById('custName').value || "Anonymous", document.getElementById('rating').value, document.getElementById('comment').value, ethers.id(document.getElementById('receiptInput').value));
                await tx.wait(); window.location.href = `store.html?id=${document.getElementById('bizInput').value}`;
            } catch (e) { alert(e.message); btn.disabled = false; btn.innerText = "Publish On-Chain"; }
        }
    </script>
</body>
</html>
