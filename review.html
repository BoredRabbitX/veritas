<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"><title>Submit Review V3 | Veritas</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <style>
        #v3Debug { background: #000; color: #0f0; font-family: monospace; font-size: 11px; padding: 15px; border-radius: 12px; margin-top: 20px; max-height: 200px; overflow-y: auto; border: 1px solid #333; }
        .d-err { color: #f44; } .d-warn { color: #fa0; }
    </style>
</head>
<body class="flex flex-col min-h-screen">
    <div class="nav-container"><nav class="max-w-7xl mx-auto p-4 flex justify-between items-center"><a href="index.html" class="font-black text-2xl">VERITAS</a><button id="connectBtn" class="btn-primary text-sm" onclick="connectWallet()">Connect</button></nav></div>

    <main class="main-content max-w-lg mx-auto px-6 py-12">
        <div class="card-veritas shadow-2xl">
            <h2 class="text-3xl font-black mb-6">Post Review</h2>
            <div id="gate" class="space-y-4">
                <input id="bizInput" type="text" placeholder="Merchant Wallet">
                <input id="receiptInput" type="text" placeholder="Receipt ID (V3-...)">
                <button onclick="verifyReceipt()" class="btn-primary w-full py-4">Verify Receipt On-chain</button>
            </div>
            
            <div id="denied" class="hidden p-4 my-4 bg-red-900/20 text-red-400 rounded-xl text-xs border border-red-900/50">
                <strong>Error:</strong> <span id="reason"></span>
            </div>

            <div id="form" class="hidden space-y-6">
                <div class="p-4 bg-blue-900/10 rounded-xl border border-blue-900/20"><p id="storeLabel" class="text-blue-600 font-bold"></p></div>
                <input id="custName" type="text" placeholder="Your Name">
                <select id="rating"><option value="5">⭐⭐⭐⭐⭐ Excellent</option><option value="1">⭐ Terrible</option></select>
                <textarea id="comment" placeholder="Feedback..." rows="4"></textarea>
                <button id="subBtn" onclick="sendReview()" class="btn-primary w-full py-4">Publish to Blockchain</button>
            </div>

            <div id="v3Debug"><div>> VERITAS V3 DEBUGGER READY...</div></div>
        </div>
    </main>
    <footer><div class="max-w-7xl mx-auto px-6 flex justify-between items-center text-[10px] font-bold opacity-30"><div>VERITAS V3</div></div></footer>

    <script src="app.js"></script>
    <script>
        function logV3(m, t='info') {
            const d = document.getElementById('v3Debug');
            const div = document.createElement('div');
            if(t !== 'info') div.className = t === 'err' ? 'd-err' : 'd-warn';
            div.innerText = `[${new Date().toLocaleTimeString().split(' ')[0]}] ${m}`;
            d.appendChild(div); d.scrollTop = d.scrollHeight;
        }

        const urlP = new URLSearchParams(window.location.search);
        window.onload = () => {
            if(urlP.get('business')) document.getElementById('bizInput').value = urlP.get('business');
            if(urlP.get('receipt')) document.getElementById('receiptInput').value = urlP.get('receipt');
        };

        async function verifyReceipt() {
            const bA = document.getElementById('bizInput').value.trim();
            const rid = document.getElementById('receiptInput').value.trim();
            logV3(`Validating receipt: ${rid}...`);
            try {
                if(!contract) await connectWallet();
                const hash = ethers.keccak256(ethers.toUtf8Bytes(rid));
                
                const [isValid, isUsed, biz, user] = await Promise.all([
                    contract.validReceipts(hash),
                    contract.usedReceipts(hash),
                    contract.businesses(bA),
                    signer.getAddress()
                ]);

                logV3(`On-chain Status - Valid: ${isValid}, Used: ${isUsed}`);
                
                if(!isValid) throw new Error("Receipt NOT issued by merchant.");
                if(isUsed) throw new Error("Receipt already used.");
                if(user.toLowerCase() === bA.toLowerCase()) throw new Error("Self-review blocked.");

                document.getElementById('gate').classList.add('hidden');
                document.getElementById('denied').classList.add('hidden');
                document.getElementById('form').classList.remove('hidden');
                document.getElementById('storeLabel').innerText = "Verified for: " + biz.name;
                logV3("Success: Form unlocked.", "info");
            } catch (e) {
                logV3(e.message, "err");
                document.getElementById('denied').classList.remove('hidden');
                document.getElementById('reason').innerText = e.message;
            }
        }

       async function sendReview() {
    const btn = document.getElementById('subBtn');
    try {
        btn.disabled = true; 
        btn.innerText = "Encoding Data...";

        const bizAddr = document.getElementById('bizInput').value.trim();
        const rid = document.getElementById('receiptInput').value.trim();
        
        // Pulizia stringhe: evitiamo caratteri speciali che rompono l'ABI
        const name = (document.getElementById('custName').value || "Anon").replace(/[^a-zA-Z0-9 ]/g, "");
        const comment = (document.getElementById('comment').value || "Review").replace(/[^a-zA-Z0-9 ]/g, "");
        const rating = parseInt(document.getElementById('rating').value);
        
        const hash = ethers.keccak256(ethers.toUtf8Bytes(rid));
        
        logV3("Final pre-flight check...");
        logV3(`Target: ${bizAddr.slice(0,10)}...`);
        logV3(`Rating: ${rating} Stars`);

        // Eseguiamo la chiamata forzando la codifica ABI pulita
        const tx = await contract.postReview(
            bizAddr,
            name,
            rating,
            comment,
            hash,
            { 
                gasLimit: 400000,
                // Rimuoviamo il tipo per permettere a MetaMask di negoziare il formato migliore
            }
        );
        
        logV3("TX Sent! Waiting for block confirmation...", "warn");
        const receipt = await tx.wait();
        
        if(receipt.status === 1) {
            logV3("Success! Review stored on-chain.", "info");
            window.location.href = `store.html?id=${bizAddr}`;
        } else {
            throw new Error("Transaction failed on-chain.");
        }

    } catch (e) {
        console.error("Critical Error Detail:", e);
        let errorMsg = e.message;
        
        if (e.message.includes("Internal JSON-RPC error")) {
            errorMsg = "RPC Conflict: Try changing the 'Name' or 'Comment' to simple text.";
        }
        
        logV3(errorMsg, "err");
        alert("Blockchain Error: " + errorMsg);
        btn.disabled = false; 
        btn.innerText = "Publish to Blockchain";
    }
}
    </script>
</body>
</html>
