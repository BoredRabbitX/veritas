<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"><title>Review | Veritas</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
</head>
<body>
    <div class="nav-container">
        <nav class="max-w-7xl mx-auto p-4 flex justify-between items-center">
            <a href="index.html" class="flex items-center gap-2"><div class="w-10 h-10 bg-blue-600 rounded-xl flex items-center justify-center text-white font-bold">V</div><span class="text-2xl font-bold">Veritas</span></a>
            <div class="flex items-center gap-6"><button id="darkModeToggle">üåì</button><button id="connectBtn" class="btn-primary text-sm" onclick="connectWallet()">Connect Wallet</button></div>
        </nav>
    </div>

    <main class="main-content max-w-2xl mx-auto px-6 py-12">
        <div class="card-veritas">
            <h2 class="text-3xl font-bold mb-6">Post a Review</h2>
            
            <div id="setupData" class="space-y-4 mb-8 p-4 bg-gray-50 dark:bg-gray-800/50 rounded-xl">
                <p class="text-xs font-bold uppercase opacity-50">Transaction Details</p>
                <input id="bizInput" type="text" placeholder="Merchant Wallet Address (0x...)">
                <input id="receiptInput" type="text" placeholder="Receipt / Order ID">
                <button onclick="processValidation()" class="btn-outline w-full">Verify Transaction</button>
            </div>

            <div id="denied" class="hidden p-4 mb-6 bg-red-100 text-red-700 rounded-lg text-sm font-medium"></div>

            <div id="form" class="hidden space-y-6">
                <div class="border-b pb-4"><p class="text-blue-600 font-bold" id="storeName">Reviewing: ...</p></div>
                <div><label class="block text-xs font-bold mb-2">SCORE</label><select id="r"><option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê Excellent</option><option value="1">‚≠ê Poor</option></select></div>
                <div><label class="block text-xs font-bold mb-2">COMMENT</label><textarea id="msg" placeholder="Share your experience..." rows="4"></textarea></div>
                <button id="submitBtn" onclick="send()" class="btn-primary w-full py-4 text-lg">Publish to Blockchain</button>
            </div>
        </div>
    </main>

    <footer><div class="max-w-7xl mx-auto px-6 flex justify-between items-center text-[10px] uppercase font-bold opacity-50"><div>The White Rabbit bored creation</div><div>Powered by Polkadot paseo testnet</div></div></footer>

    <script src="app.js"></script>
    <script>
        window.onload = async () => {
            const p = new URLSearchParams(window.location.search);
            if(p.get('business')) document.getElementById('bizInput').value = p.get('business');
            if(p.get('receipt')) {
                document.getElementById('receiptInput').value = p.get('receipt');
                setTimeout(processValidation, 1000); // Auto-verify if QR data exists
            }
        };

        async function processValidation() {
            const bA = document.getElementById('bizInput').value.trim().toLowerCase();
            const rI = document.getElementById('receiptInput').value.trim();
            const errorDiv = document.getElementById('denied');

            if(!bA || !rI) return alert("Enter both Merchant Address and Receipt ID");
            if(!contract) await connectWallet();

            try {
                const uA = (await signer.getAddress()).toLowerCase();
                const b = await contract.businesses(bA);
                const used = await contract.usedReceipts(ethers.id(rI));

                if(!b.isActive) throw new Error("Business not registered.");
                if(uA === bA) throw new Error("Owners cannot review themselves.");
                if(used) throw new Error("Receipt already used.");

                document.getElementById('setupData').classList.add('hidden');
                errorDiv.classList.add('hidden');
                document.getElementById('form').classList.remove('hidden');
                document.getElementById('storeName').innerText = "Reviewing: " + b.name;
            } catch (e) {
                errorDiv.innerText = e.message;
                errorDiv.classList.remove('hidden');
            }
        }

        async function send() {
            const bA = document.getElementById('bizInput').value.trim();
            const rI = document.getElementById('receiptInput').value.trim();
            try {
                const tx = await contract.postReview(bA, document.getElementById('r').value, document.getElementById('msg').value, ethers.id(rI), "0x");
                await tx.wait(); window.location.href = `store.html?id=${bA}`;
            } catch (e) { alert(e.message); }
        }
    </script>
</body>
</html>
