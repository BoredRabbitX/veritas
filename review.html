<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"><title>Submit Review | Veritas V3.5</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
</head>
<body class="flex flex-col min-h-screen">
    <div class="nav-container">
        <nav class="max-w-7xl mx-auto p-4 flex justify-between items-center">
            <a href="index.html" class="font-black text-2xl tracking-tighter">VERITAS</a>
            <div class="hidden md:flex gap-6 text-[10px] font-bold uppercase tracking-widest">
                <a href="explore.html" class="opacity-60 hover:opacity-100">Explore</a>
                <a href="review.html" class="text-blue-600">Submit Review</a>
                <a href="dashboard.html" class="opacity-60 hover:opacity-100">Merchant Hub</a>
            </div>
            <button id="connectBtn" class="btn-primary text-xs" onclick="connectWallet()">Connect</button>
        </nav>
    </div>

    <main class="main-content max-w-lg mx-auto px-6 py-12">
        <div class="card-veritas shadow-2xl">
            <h2 class="text-3xl font-black mb-8 italic">Verified Review</h2>
            
            <div id="step1" class="space-y-4">
                <div>
                    <label class="text-[10px] font-bold uppercase opacity-50 ml-1">Select Store</label>
                    <select id="bizSelect" class="mt-1 w-full bg-gray-50 dark:bg-zinc-800 p-3 rounded-xl border border-gray-100 dark:border-zinc-700">
                        <option value="">Loading stores from blockchain...</option>
                    </select>
                </div>
                <div>
                    <label class="text-[10px] font-bold uppercase opacity-50 ml-1">Receipt ID</label>
                    <input id="receiptID" type="text" placeholder="V35-XXXXXX">
                </div>
                <button onclick="validateOnChain()" class="btn-primary w-full py-4">Verify Receipt</button>
            </div>

            <div id="step2" class="hidden space-y-4">
                <div class="p-4 bg-blue-100 dark:bg-blue-900/30 rounded-xl text-center">
                    <p id="bizLabel" class="text-blue-600 font-bold uppercase text-xs"></p>
                </div>
                <input id="nameIn" type="text" placeholder="Display Name">
                <select id="rateIn">
                    <option value="5">⭐⭐⭐⭐⭐ Excellent</option>
                    <option value="4">⭐⭐⭐⭐ Very Good</option>
                    <option value="3">⭐⭐⭐ Average</option>
                    <option value="2">⭐⭐ Poor</option>
                    <option value="1">⭐ Terrible</option>
                </select>
                <textarea id="commentIn" placeholder="Your experience..." rows="4"></textarea>
                <button id="pubBtn" onclick="submitReview()" class="btn-primary w-full py-4">Publish Review</button>
            </div>
        </div>
    </main>
    <footer class="text-center p-8 opacity-20 text-[9px] font-bold">VERITAS V3.5</footer>
    <script src="app.js"></script>
    <script>
        window.onload = async () => {
            await connectWallet(true);
            const filter = contract.filters.BusinessRegistered();
            const events = await contract.queryFilter(filter, 0);
            const select = document.getElementById('bizSelect');
            select.innerHTML = '<option value="">-- Choose Store --</option>';
            
            const unique = [...new Set(events.map(e => e.args.owner))];
            for(let addr of unique) {
                const biz = await contract.businesses(addr);
                if(biz.isActive) {
                    const opt = document.createElement('option');
                    opt.value = addr; opt.innerText = biz.name;
                    select.appendChild(opt);
                }
            }
            if(new URLSearchParams(window.location.search).get('business')) {
                select.value = new URLSearchParams(window.location.search).get('business');
                document.getElementById('receiptID').value = new URLSearchParams(window.location.search).get('receipt');
            }
        };

        async function validateOnChain() {
            const biz = document.getElementById('bizSelect').value;
            const rid = document.getElementById('receiptID').value.trim();
            try {
                const hash = ethers.keccak256(ethers.toUtf8Bytes(rid));
                const [isValid, isUsed, bizData] = await Promise.all([
                    contract.validReceipts(hash), contract.usedReceipts(hash), contract.businesses(biz)
                ]);
                if(!isValid) throw new Error("Receipt not found on-chain.");
                if(isUsed) throw new Error("Receipt already used.");
                document.getElementById('step1').classList.add('hidden');
                document.getElementById('step2').classList.remove('hidden');
                document.getElementById('bizLabel').innerText = bizData.name;
            } catch(e) { alert(e.message); }
        }

        async function submitReview() {
            const btn = document.getElementById('pubBtn');
            try {
                btn.disabled = true; btn.innerText = "Processing...";
                const tx = await contract.postReview(
                    document.getElementById('bizSelect').value,
                    document.getElementById('nameIn').value || "Anon",
                    parseInt(document.getElementById('rateIn').value),
                    document.getElementById('commentIn').value || "Review",
                    ethers.keccak256(ethers.toUtf8Bytes(document.getElementById('receiptID').value.trim())),
                    { gasLimit: 500000, type: 0 }
                );
                await tx.wait();
                window.location.href = "store.html?id=" + document.getElementById('bizSelect').value;
            } catch(e) { alert(e.message); btn.disabled = false; btn.innerText = "Publish Review"; }
        }
    </script>
</body>
</html>
