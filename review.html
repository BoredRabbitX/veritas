<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"><title>Review | Veritas</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
</head>
<body>
    <div class="nav-container">
        <nav class="max-w-7xl mx-auto p-4 flex justify-between items-center">
            <a href="index.html" class="flex items-center gap-2"><div class="w-10 h-10 bg-blue-600 rounded-xl flex items-center justify-center text-white font-bold">V</div><span class="text-2xl font-bold">Veritas</span></a>
            <button id="connectBtn" class="btn-primary text-sm" onclick="connectWallet()">Connect</button>
        </nav>
    </div>
    <main class="main-content max-w-2xl mx-auto px-6 py-12">
        <div class="card-veritas">
            <h2 class="text-3xl font-bold mb-6">Write a Review</h2>
            <div id="setupData" class="space-y-4 mb-8">
                <input id="bizInput" type="text" placeholder="Merchant Address (0x...)">
                <input id="receiptInput" type="text" placeholder="Receipt ID">
                <button onclick="processValidation()" class="btn-outline w-full">Verify & Continue</button>
            </div>
            <div id="denied" class="hidden p-4 mb-6 bg-red-100 text-red-700 rounded-lg"></div>
            <div id="form" class="hidden space-y-4">
                <p class="text-blue-600 font-bold" id="storeName"></p>
                <input id="custName" type="text" placeholder="Your Name">
                <select id="r"><option value="5">⭐⭐⭐⭐⭐ Excellent</option><option value="4">⭐⭐⭐⭐ Great</option><option value="1">⭐ Poor</option></select>
                <textarea id="msg" placeholder="Your feedback..." rows="4"></textarea>
                <button id="submitBtn" onclick="send()" class="btn-primary w-full py-4">Post to Blockchain</button>
            </div>
        </div>
    </main>
    <script src="app.js"></script>
    <script>
        const p = new URLSearchParams(window.location.search);
        window.onload = () => {
            if(p.get('business')) document.getElementById('bizInput').value = p.get('business');
            if(p.get('receipt')) document.getElementById('receiptInput').value = p.get('receipt');
        };
        async function processValidation() {
            const bA = document.getElementById('bizInput').value.trim();
            const rI = document.getElementById('receiptInput').value.trim();
            if(!contract) await connectWallet();
            try {
                const b = await contract.businesses(bA);
                if(!b.isActive) throw new Error("Store not registered.");
                document.getElementById('setupData').classList.add('hidden');
                document.getElementById('form').classList.remove('hidden');
                document.getElementById('storeName').innerText = "Reviewing: " + b.name;
            } catch (e) { alert(e.message); }
        }
        async function send() {
            const btn = document.getElementById('submitBtn');
            try {
                btn.disabled = true; btn.innerText = "Processing...";
                const tx = await contract.postReview(document.getElementById('bizInput').value, document.getElementById('custName').value || "Anon", document.getElementById('r').value, document.getElementById('msg').value, ethers.id(document.getElementById('receiptInput').value));
                await tx.wait(); window.location.href = `store.html?id=${document.getElementById('bizInput').value}`;
            } catch (e) { alert(e.message); btn.disabled = false; btn.innerText = "Post to Blockchain"; }
        }
    </script>
</body>
</html>
