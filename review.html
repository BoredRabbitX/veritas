<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Write Review | Veritas</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body class="bg-[var(--bg-main)]">
    <div id="header-root"></div>
    <main class="max-w-2xl mx-auto px-6 py-20">
        <div class="card-veritas p-12">
            <h1 class="text-5xl font-black italic uppercase mb-8 leading-none">Submit <span class="text-blue-600">Review</span></h1>
            
            <div class="space-y-6">
                <div>
                    <label class="text-[10px] font-black uppercase opacity-40 mb-2 block">Merchant Address</label>
                    <input id="mAddr" class="w-full" placeholder="0x...">
                </div>
                <div>
                    <label class="text-[10px] font-black uppercase opacity-40 mb-2 block">Receipt ID</label>
                    <input id="rId" class="w-full" placeholder="Enter your unique log ID">
                </div>
                <div>
                    <label class="text-[10px] font-black uppercase opacity-40 mb-2 block">Rating (1-5)</label>
                    <select id="stars" class="w-full">
                        <option value="5">5 Stars - Excellent</option>
                        <option value="4">4 Stars - Good</option>
                        <option value="3">3 Stars - Average</option>
                        <option value="2">2 Stars - Poor</option>
                        <option value="1">1 Star - Terrible</option>
                    </select>
                </div>
                <div>
                    <label class="text-[10px] font-black uppercase opacity-40 mb-2 block">Your Experience</label>
                    <textarea id="comment" class="w-full h-32" placeholder="Tell the community about your experience..."></textarea>
                </div>
                <button onclick="submit()" class="btn-primary w-full py-5 text-sm uppercase tracking-widest">Publish on Blockchain</button>
            </div>
        </div>
    </main>
    <div id="footer-root"></div>

    <script src="app.js"></script>
    <script src="components.js"></script>
    <script>
        async function submit() {
            if(!signer) return alert("Connect wallet first!");
            const m = document.getElementById('mAddr').value;
            const r = document.getElementById('rId').value;
            const s = document.getElementById('stars').value;
            const c = document.getElementById('comment').value;

            try {
                // Controllo sicurezza: Verifica se la ricevuta esiste
                const issuer = await engContract.receiptIssuers(r);
                if(issuer.toLowerCase() !== m.toLowerCase()) {
                    return alert("Invalid Receipt ID for this merchant!");
                }

                const tx = await revContract.submitReview(m, s, c, r);
                alert("Transaction sent! Wait for block confirmation...");
                await tx.wait();
                alert("Review Published!");
                window.location.href = "explore.html";
            } catch(e) { 
                console.error(e);
                alert("Transaction failed. Make sure you have PAS tokens."); 
            }
        }
        function initPage() { console.log("Review Page Ready"); }
    </script>
</body>
</html>
