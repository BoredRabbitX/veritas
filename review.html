<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8"><title>Veritas V3.5 | Review</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <style>#v3Debug { background:#000; color:#0f0; font-family:monospace; font-size:10px; padding:12px; border-radius:12px; margin-top:20px; border:1px solid #333; height:120px; overflow-y:auto; }</style>
</head>
<body class="flex flex-col min-h-screen">
    <div class="nav-container"><nav class="max-w-7xl mx-auto p-4 flex justify-between items-center"><a href="index.html" class="font-black text-2xl tracking-tighter">VERITAS</a><button id="connectBtn" class="btn-primary" onclick="connectWallet()">Connetti</button></nav></div>

    <main class="main-content max-w-lg mx-auto px-6 py-12">
        <div class="card-veritas shadow-2xl">
            <h2 class="text-3xl font-black mb-6 italic">Verifica & Invia</h2>
            <div id="step1" class="space-y-4">
                <input id="bizAddr" type="text" placeholder="Indirizzo Negozio">
                <input id="receiptID" type="text" placeholder="Codice Scontrino (V35-...)">
                <button onclick="validateOnChain()" class="btn-primary w-full py-4">Verifica Validità On-Chain</button>
            </div>

            <div id="step2" class="hidden space-y-4 animate-in fade-in duration-500">
                <div class="p-3 bg-blue-100 dark:bg-blue-900/30 rounded-xl text-center"><p id="bizLabel" class="text-blue-600 font-bold"></p></div>
                <input id="nameIn" type="text" placeholder="Il tuo nome (Semplice)">
                <select id="rateIn"><option value="5">⭐⭐⭐⭐⭐ 5 Stelle</option><option value="4">⭐⭐⭐⭐ 4 Stelle</option><option value="1">⭐ 1 Stella</option></select>
                <textarea id="commentIn" placeholder="Il tuo commento (Senza caratteri speciali)..." rows="3"></textarea>
                <button id="pubBtn" onclick="submitReview()" class="btn-primary w-full py-4 shadow-xl">PUBBLICA SU BLOCKCHAIN</button>
            </div>
            <div id="v3Debug">> In attesa di input...</div>
        </div>
    </main>
    <footer class="text-center p-8 opacity-30 text-[9px] font-bold">VERITAS PROTOCOL V3.5</footer>

    <script src="app.js"></script>
    <script>
        function log(m) { const d = document.getElementById('v3Debug'); d.innerText += "\n> " + m; d.scrollTop = d.scrollHeight; }
        const urlParams = new URLSearchParams(window.location.search);
        
        window.onload = () => {
            if(urlParams.get('business')) document.getElementById('bizAddr').value = urlParams.get('business');
            if(urlParams.get('receipt')) document.getElementById('receiptID').value = urlParams.get('receipt');
        };

        async function validateOnChain() {
            try {
                if(!contract) await connectWallet();
                const rid = document.getElementById('receiptID').value.trim();
                const hash = ethers.keccak256(ethers.toUtf8Bytes(rid));
                log("Controllo scontrino: " + rid);

                const [isValid, isUsed, biz] = await Promise.all([
                    contract.validReceipts(hash),
                    contract.usedReceipts(hash),
                    contract.businesses(document.getElementById('bizAddr').value.trim())
                ]);

                if(!isValid) throw new Error("Scontrino NON emesso dal merchant!");
                if(isUsed) throw new Error("Scontrino già speso!");

                document.getElementById('step1').classList.add('hidden');
                document.getElementById('step2').classList.remove('hidden');
                document.getElementById('bizLabel').innerText = "Negozio: " + biz.name;
                log("Scontrino VALIDO. Form sbloccato.");
            } catch(e) { log("ERRORE: " + e.message); alert(e.message); }
        }

        async function submitReview() {
            const btn = document.getElementById('pubBtn');
            try {
                btn.disabled = true; btn.innerText = "Cifratura...";
                const rid = document.getElementById('receiptID').value.trim();
                const hash = ethers.keccak256(ethers.toUtf8Bytes(rid));
                const name = (document.getElementById('nameIn').value || "Anon").replace(/[^a-zA-Z0-9 ]/g, "");
                const comment = (document.getElementById('commentIn').value || "Ottimo").replace(/[^a-zA-Z0-9 ]/g, "");

                log("Inviando con Gas Manuale (500k)...");
                const tx = await contract.postReview(
                    document.getElementById('bizAddr').value.trim(),
                    name,
                    parseInt(document.getElementById('rateIn').value),
                    comment,
                    hash,
                    { gasLimit: 500000, type: 0 }
                );
                log("Firma ottenuta! In attesa del blocco...");
                await tx.wait();
                log("SUCCESSO! Reindirizzamento...");
                window.location.href = "store.html?id=" + document.getElementById('bizAddr').value.trim();
            } catch(e) { log("FALLITO: " + e.message.slice(0,50)); btn.disabled = false; btn.innerText = "PUBBLICA SU BLOCKCHAIN"; }
        }
    </script>
</body>
</html>
