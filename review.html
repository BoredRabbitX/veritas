<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"><title>Submit Review | Veritas V3.5</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <style>#v3Debug { background:#000; color:#0f0; font-family:monospace; font-size:10px; padding:12px; border-radius:12px; margin-top:20px; border:1px solid #333; height:100px; overflow-y:auto; }</style>
</head>
<body class="flex flex-col min-h-screen">
    <div class="nav-container"><nav class="max-w-7xl mx-auto p-4 flex justify-between items-center"><a href="index.html" class="font-black text-2xl tracking-tighter">VERITAS</a><button id="connectBtn" class="btn-primary" onclick="connectWallet()">Connect</button></nav></div>

    <main class="main-content max-w-lg mx-auto px-6 py-12">
        <div class="card-veritas shadow-2xl">
            <h2 class="text-3xl font-black mb-6 italic">Verified Review</h2>
            
            <div id="step1" class="space-y-4">
                <div>
                    <label class="text-[10px] font-bold uppercase opacity-50 ml-1">Select Store</label>
                    <select id="bizSelect" class="mt-1">
                        <option value="">Loading registered stores...</option>
                    </select>
                </div>
                <div>
                    <label class="text-[10px] font-bold uppercase opacity-50 ml-1">Receipt ID</label>
                    <input id="receiptID" type="text" placeholder="Enter V35-XXXX code">
                </div>
                <button onclick="validateOnChain()" class="btn-primary w-full py-4">Verify Receipt</button>
            </div>

            <div id="step2" class="hidden space-y-4">
                <div class="p-4 bg-blue-100 dark:bg-blue-900/30 rounded-xl text-center">
                    <p id="bizLabel" class="text-blue-600 font-bold uppercase text-xs"></p>
                </div>
                <input id="nameIn" type="text" placeholder="Your Display Name">
                <select id="rateIn">
                    <option value="5">⭐⭐⭐⭐⭐ Excellent</option>
                    <option value="4">⭐⭐⭐⭐ Great</option>
                    <option value="3">⭐⭐⭐ Average</option>
                    <option value="2">⭐⭐ Poor</option>
                    <option value="1">⭐ Terrible</option>
                </select>
                <textarea id="commentIn" placeholder="Describe your experience (plain text only)..." rows="4"></textarea>
                <button id="pubBtn" onclick="submitReview()" class="btn-primary w-full py-4">Publish to Blockchain</button>
            </div>

            <div id="v3Debug">> Waiting for connection...</div>
        </div>
    </main>

    <script src="app.js"></script>
    <script>
        function log(m) { const d = document.getElementById('v3Debug'); d.innerText += "\n> " + m; d.scrollTop = d.scrollHeight; }
        const urlParams = new URLSearchParams(window.location.search);
        
        window.onload = async () => {
            await connectWallet(true);
            await loadStores();
            
            // Auto-fill if URL has params (from QR)
            const bParam = urlParams.get('business');
            const rParam = urlParams.get('receipt');
            if(bParam) document.getElementById('bizSelect').value = bParam;
            if(rParam) document.getElementById('receiptID').value = rParam;
        };

        async function loadStores() {
            try {
                const filter = contract.filters.BusinessRegistered();
                const events = await contract.queryFilter(filter, 0);
                const select = document.getElementById('bizSelect');
                select.innerHTML = '<option value="">-- Choose a Store --</option>';
                
                const uniqueAddresses = [...new Set(events.map(e => e.args.owner))];
                for(let addr of uniqueAddresses) {
                    const biz = await contract.businesses(addr);
                    if(biz.isActive) {
                        const opt = document.createElement('option');
                        opt.value = addr;
                        opt.innerText = biz.name;
                        select.appendChild(opt);
                    }
                }
                log("Stores loaded from blockchain.");
            } catch(e) { log("Error loading stores: " + e.message); }
        }

        async function validateOnChain() {
            const bizAddr = document.getElementById('bizSelect').value;
            const rid = document.getElementById('receiptID').value.trim();
            if(!bizAddr || !rid) { alert("Please select a store and enter a receipt ID."); return; }

            try {
                const hash = ethers.keccak256(ethers.toUtf8Bytes(rid));
                log("Validating hash: " + hash.slice(0,12));

                const [isValid, isUsed, biz] = await Promise.all([
                    contract.validReceipts(hash),
                    contract.usedReceipts(hash),
                    contract.businesses(bizAddr)
                ]);

                if(!isValid) throw new Error("Receipt NOT issued by merchant!");
                if(isUsed) throw new Error("Receipt already used!");

                document.getElementById('step1').classList.add('hidden');
                document.getElementById('step2').classList.remove('hidden');
                document.getElementById('bizLabel').innerText = biz.name;
                log("Validation successful.");
            } catch(e) { log("ERROR: " + e.message); alert(e.message); }
        }

        async function submitReview() {
            const btn = document.getElementById('pubBtn');
            try {
                btn.disabled = true; btn.innerText = "Processing...";
                const rid = document.getElementById('receiptID').value.trim();
                const hash = ethers.keccak256(ethers.toUtf8Bytes(rid));
                const name = (document.getElementById('nameIn').value || "Anon").replace(/[^a-zA-Z0-9 ]/g, "");
                const comment = (document.getElementById('commentIn').value || "Review").replace(/[^a-zA-Z0-9 ]/g, "");

                const tx = await contract.postReview(
                    document.getElementById('bizSelect').value,
                    name,
                    parseInt(document.getElementById('rateIn').value),
                    comment,
                    hash,
                    { gasLimit: 500000, type: 0 }
                );
                log("Transaction sent. Pending...");
                await tx.wait();
                log("Confirmed!");
                window.location.href = "store.html?id=" + document.getElementById('bizSelect').value;
            } catch(e) { log(e.message); btn.disabled = false; btn.innerText = "Publish Review"; }
        }
    </script>
</body>
</html>
