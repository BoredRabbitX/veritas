<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"><title>Review V3 | Veritas</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
</head>
<body>
    <div class="nav-container"><nav class="max-w-7xl mx-auto p-4 flex justify-between items-center"><a href="index.html" class="font-black text-2xl">VERITAS</a><button id="connectBtn" class="btn-primary text-sm" onclick="connectWallet()">Connect</button></nav></div>

    <main class="main-content max-w-lg mx-auto px-6 py-12">
        <div class="card-veritas">
            <h2 class="text-3xl font-black mb-8">Write Review</h2>
            <div id="setupData" class="space-y-4">
                <input id="bizInput" type="text" placeholder="Merchant 0x...">
                <input id="receiptInput" type="text" placeholder="Receipt ID (V3-...)">
                <button onclick="verify()" class="btn-primary w-full">Verify Receipt On-chain</button>
            </div>
            <div id="reviewForm" class="hidden space-y-4">
                <p id="storeName" class="text-blue-600 font-bold"></p>
                <input id="custName" type="text" placeholder="Your Name">
                <select id="rating"><option value="5">⭐⭐⭐⭐⭐</option><option value="1">⭐</option></select>
                <textarea id="comment" placeholder="Feedback..." rows="4"></textarea>
                <button id="submitBtn" onclick="send()" class="btn-primary w-full">Post Review</button>
            </div>
        </div>
    </main>
    <footer><div class="max-w-7xl mx-auto px-6 flex justify-between items-center text-[10px] uppercase font-bold opacity-30"><div>The White Rabbit</div><div>VERITAS PROTOCOL V3</div></div></footer>
    <script src="app.js"></script>
    <script>
        const p = new URLSearchParams(window.location.search);
        window.onload = () => {
            if(p.get('business')) document.getElementById('bizInput').value = p.get('business');
            if(p.get('receipt')) document.getElementById('receiptInput').value = p.get('receipt');
        };
        async function verify() {
            const bA = document.getElementById('bizInput').value.trim();
            const rid = document.getElementById('receiptInput').value.trim();
            if(!contract) await connectWallet();
            try {
                const hash = ethers.keccak256(ethers.toUtf8Bytes(rid));
                const isValid = await contract.validReceipts(hash);
                const isUsed = await contract.usedReceipts(hash);
                const biz = await contract.businesses(bA);

                if(!isValid) throw new Error("Receipt NOT found on-chain. Merchant must issue it first.");
                if(isUsed) throw new Error("Receipt already spent.");
                
                document.getElementById('setupData').classList.add('hidden');
                document.getElementById('reviewForm').classList.remove('hidden');
                document.getElementById('storeName').innerText = "Verified for: " + biz.name;
            } catch (e) { alert(e.message); }
        }
        async function send() {
            const bA = document.getElementById('bizInput').value.trim();
            const rid = document.getElementById('receiptInput').value.trim();
            const hash = ethers.keccak256(ethers.toUtf8Bytes(rid));
            try {
                const tx = await contract.postReview(bA, document.getElementById('custName').value, document.getElementById('rating').value, document.getElementById('comment').value, hash);
                await tx.wait(); window.location.href = `store.html?id=${bA}`;
            } catch (e) { alert(e.message); }
        }
    </script>
</body>
</html>
