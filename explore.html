<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Explore | Veritas</title>
    <link rel="stylesheet" href="style.css"><script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
</head>
<body class="flex flex-col min-h-screen">
    <div id="header-root"></div>
    <main class="flex-grow p-6 py-20">
        <div class="max-w-7xl mx-auto text-center">
            <h1 class="text-7xl font-black italic uppercase mb-12">Verified <span class="text-blue-600">Stores</span></h1>
            <div id="grid" class="grid md:grid-cols-3 gap-8"></div>
        </div>
    </main>
    <div id="footer-root"> </div> <script src="app.js"> </script>
    <script src="app.js"></script><script src="components.js"></script>
    <script>
    async function initPage() {
    try {
        const grid = document.getElementById('grid');
        if (!grid) return;
        
        grid.innerHTML = "<p class='opacity-50 uppercase text-[10px] animate-pulse'>Accessing Polkadot Ledger...</p>";

        // 1. Recupera tutti gli eventi di registrazione
        const filter = regContract.filters.BusinessRegistered();
        const events = await regContract.queryFilter(filter, -100000); // ultimi 100k blocchi
        
        // 2. FILTRO DUPLICATI: Creiamo un Set di indirizzi unici
        // Usiamo un Set per assicurarci che ogni indirizzo compaia UNA sola volta
        const uniqueAddresses = [...new Set(events.map(e => e.args.owner || e.args[0]))];
        
        grid.innerHTML = ""; // Puliamo il loader
        
        if (uniqueAddresses.length === 0) {
            grid.innerHTML = "<p class='opacity-30 uppercase text-[10px]'>No merchants registered yet.</p>";
            return;
        }

        // 3. Ciclo sugli indirizzi UNICI (in ordine inverso per vedere i pi√π recenti)
        for(let addr of uniqueAddresses.reverse()) {
            const b = await regContract.businesses(addr);
            
            // Saltiamo i merchant non attivi
            if(!b.isActive) continue;
            
            const cleanCat = ethers.decodeBytes32String(b.category).split('_').join(' ');
            
            grid.innerHTML += `
                <a href="store.html?id=${addr}" class="p-10 rounded-[2.5rem] border border-[var(--border)] bg-[var(--card-bg)] hover:border-blue-600 transition-all duration-500 block text-left group shadow-lg">
                    <div class="flex justify-between items-start mb-6">
                        <p class="text-blue-600 text-[10px] font-black uppercase tracking-[0.2em]">${cleanCat}</p>
                        <div class="w-2 h-2 rounded-full bg-green-500 shadow-[0_0_10px_rgba(34,197,94,0.5)]"></div>
                    </div>
                    <h3 class="text-4xl font-black italic uppercase leading-none mb-6 tracking-tighter group-hover:text-blue-500 transition-colors">${b.name}</h3>
                    <div class="flex justify-between items-center opacity-30 text-[9px] font-bold uppercase tracking-widest pt-6 border-t border-[var(--border)]">
                        <span>${b.volume} Verified Logs</span>
                        <span class="font-mono">${addr.slice(0,6)}...${addr.slice(-4)}</span>
                    </div>
                </a>`;
        }
    } catch (e) {
        console.error("Explore error:", e);
        if(document.getElementById('grid')) {
            document.getElementById('grid').innerHTML = "<p class='text-red-500 text-[10px] font-bold uppercase'>Sync Error. Please Refresh.</p>";
        }
    }
}
    </script>
</body>
</html>
