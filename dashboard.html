<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Merchant Hub | Veritas</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>
<body class="flex flex-col min-h-screen">

    <div class="nav-container">
        <nav class="max-w-7xl mx-auto p-4 flex justify-between items-center">
            <a href="index.html" class="font-black text-2xl italic tracking-tighter">VERITAS</a>
            <div class="hidden md:flex gap-6 text-[10px] font-bold uppercase tracking-widest">
                <a href="explore.html" class="opacity-60 hover:opacity-100 transition">Explore</a>
                <a href="review.html" class="opacity-60 hover:opacity-100 transition">Submit Review</a>
                <a href="dashboard.html" class="text-blue-600 border-b-2 border-blue-600">Merchant Hub</a>
            </div>
            <button id="connectBtn" class="btn-primary text-xs" onclick="connectWallet()">Connect Wallet</button>
        </nav>
    </div>

    <main class="flex-grow max-w-7xl mx-auto px-6 py-12 w-full">
        <div id="loadingOverlay" class="fixed inset-0 bg-black z-50 flex items-center justify-center transition-opacity duration-500">
            <div class="text-blue-600 font-black animate-pulse tracking-widest uppercase text-xs">Syncing Protocol...</div>
        </div>

        <div id="dashboardContent" class="hidden opacity-0 transition-opacity duration-700">
            <h1 class="text-6xl font-black italic tracking-tighter uppercase mb-12">Merchant Hub</h1>

            <div class="grid lg:grid-cols-3 gap-8">
                <div class="space-y-6">
                    <div class="card-veritas bg-gradient-to-br from-blue-600/10 to-transparent">
                        <div class="flex items-center gap-4 mb-8">
                            <div class="w-14 h-14 bg-blue-600 rounded-2xl flex items-center justify-center text-2xl shadow-lg">üè™</div>
                            <div>
                                <h2 id="dispStoreName" class="text-2xl font-black italic uppercase leading-none text-white">---</h2>
                                <p id="dispStoreCat" class="text-[10px] font-bold text-blue-500 uppercase tracking-widest mt-1">---</p>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4 border-t border-white/5 pt-6">
                            <div>
                                <p class="text-[8px] font-bold opacity-40 uppercase tracking-widest mb-1">Reputation</p>
                                <div class="flex items-center gap-1">
                                    <span id="dispAvg" class="text-3xl font-black text-blue-600">--</span>
                                    <span class="text-yellow-500 text-xs">‚òÖ</span>
                                </div>
                            </div>
                            <div>
                                <p class="text-[8px] font-bold opacity-40 uppercase tracking-widest mb-1">Reviews</p>
                                <span id="dispCount" class="text-3xl font-black text-white">0</span>
                            </div>
                        </div>
                    </div>
                    <div class="card-veritas py-4">
                        <p class="text-[9px] font-bold opacity-30 uppercase mb-2">Merchant ID</p>
                        <p id="dispAddr" class="font-mono text-[9px] break-all opacity-50">0x...</p>
                    </div>
                </div>

                <div class="lg:col-span-2 space-y-6">
                    <div id="boxRegister" class="card-veritas hidden">
                        <h2 class="text-3xl font-black italic uppercase mb-2">Register</h2>
                        <p class="text-sm opacity-50 mb-8 italic">Your wallet is not registered. Activate your business on-chain.</p>
                        <div class="grid md:grid-cols-2 gap-4 mb-6">
                            <input id="inName" type="text" placeholder="Business Name">
                            <input id="inCat" type="text" placeholder="Category (e.g. Food)">
                        </div>
                        <button onclick="registerBusiness()" class="btn-primary w-full py-5">Register Business</button>
                    </div>

                    <div id="boxReceipt" class="card-veritas hidden">
                        <h2 class="text-3xl font-black italic uppercase mb-8">Issue Receipt QR</h2>
                        <div class="flex flex-col md:flex-row gap-10">
                            <div class="flex-grow space-y-6">
                                <p class="text-sm opacity-60 leading-relaxed italic">Generate a secure unique ID (V3-XXXX). Each ID allows one verified review.</p>
                                <div class="relative">
                                    <input id="receiptRaw" type="text" placeholder="V3-XXXXXX" readonly class="bg-black/40 pr-40 py-5 font-mono">
                                    <button onclick="generateSecureQR()" id="genBtn" class="absolute right-2 top-2 bg-blue-600 text-white text-[10px] font-black px-6 py-3 rounded-lg hover:bg-blue-700 transition-all shadow-lg">GENERATE ID</button>
                                </div>
                            </div>
                            <div class="w-full md:w-56 flex flex-col items-center">
                                <div class="bg-white p-4 rounded-3xl shadow-2xl flex items-center justify-center min-h-[200px] min-w-[200px]">
                                    <div id="qrcode" class="text-[10px] text-black font-black opacity-20 uppercase tracking-tighter">QR Standby</div>
                                </div>
                                <div id="qrStatus" class="mt-4 text-[10px] text-blue-500 font-black hidden uppercase animate-bounce">‚úì Registered On-Chain</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="loggedOutContent" class="hidden flex flex-col items-center justify-center py-32 text-center">
            <div class="w-24 h-24 bg-zinc-900 rounded-3xl flex items-center justify-center text-4xl mb-8 border border-white/5">üîí</div>
            <h2 class="text-4xl font-black italic mb-4 uppercase text-white">Merchant Access Required</h2>
            <p class="opacity-40 max-w-md mb-12 text-lg italic">Please connect your wallet to manage your profile.</p>
            <button onclick="connectWallet()" class="btn-primary px-16 py-5 text-lg shadow-2xl">Connect Wallet</button>
        </div>
    </main>

    <footer class="mt-auto py-12 border-t border-white/5">
        <div class="max-w-7xl mx-auto px-6 flex justify-between items-center opacity-30 text-[10px] font-bold uppercase tracking-widest">
            <div>The White Rabbit</div>
            <div>Veritas V3.5.3</div>
        </div>
    </footer>

    <script src="app.js"></script>
    <script>
        // Dashboard Logic
        window.addEventListener('load', () => {
            setTimeout(initDashboard, 1000);
        });

        async function initDashboard() {
            const connected = await connectWallet(true);
            const dashboard = document.getElementById('dashboardContent');
            const loggedOut = document.getElementById('loggedOutContent');
            
            if (connected && signer) {
                const addr = await signer.getAddress();
                document.getElementById('dispAddr').innerText = addr;
                
                try {
                    const biz = await contract.businesses(addr);
                    if (biz.isActive) {
                        document.getElementById('boxReceipt').classList.remove('hidden');
                        document.getElementById('dispStoreName').innerText = biz.name;
                        document.getElementById('dispStoreCat').innerText = biz.category;
                        loadStats(addr);
                    } else {
                        document.getElementById('boxRegister').classList.remove('hidden');
                    }
                } catch(e) { console.error(e); }

                dashboard.classList.remove('hidden');
                setTimeout(() => dashboard.classList.add('opacity-100'), 50);
                loggedOut.classList.add('hidden');
            } else {
                loggedOut.classList.remove('hidden');
            }
            document.getElementById('loadingOverlay').classList.add('opacity-0', 'pointer-events-none');
        }

        async function loadStats(addr) {
            try {
                const filter = contract.filters.ReviewAdded(addr);
                const events = await contract.queryFilter(filter, 0);
                if (events.length > 0) {
                    let sum = 0;
                    events.forEach(ev => sum += Number(ev.args.rating));
                    document.getElementById('dispAvg').innerText = (sum / events.length).toFixed(1);
                    document.getElementById('dispCount').innerText = events.length;
                } else {
                    document.getElementById('dispAvg').innerText = "0.0";
                }
            } catch(e) { console.error(e); }
        }

        async function registerBusiness() {
            const name = document.getElementById('inName').value;
            const cat = document.getElementById('inCat').value;
            if(!name || !cat) return alert("Fields required");
            try {
                const tx = await contract.registerBusiness(name, cat);
                await tx.wait();
                location.reload();
            } catch(e) { alert(e.message); }
        }

        async function generateSecureQR() {
            const btn = document.getElementById('genBtn');
            const input = document.getElementById('receiptRaw');
            const random = Math.random().toString(36).substring(2, 8).toUpperCase();
            const secureID = `V3-${random}`;
            input.value = secureID;
            
            btn.disabled = true;
            btn.innerText = "SIGNING...";

            try {
                const hash = ethers.keccak256(ethers.toUtf8Bytes(secureID));
                const tx = await contract.issueReceipt(hash);
                await tx.wait();

                const baseUrl = window.location.href.split('dashboard.html')[0];
                const addr = await signer.getAddress();
                const fullUrl = `${baseUrl}review.html?business=${addr}&receipt=${encodeURIComponent(secureID)}`;

                const qrDiv = document.getElementById('qrcode');
                qrDiv.innerHTML = "";
                qrDiv.classList.remove('opacity-20');
                new QRCode(qrDiv, { text: fullUrl, width: 180, height: 180 });

                document.getElementById('qrStatus').classList.remove('hidden');
                btn.innerText = "SUCCESS";
                setTimeout(() => { btn.disabled = false; btn.innerText = "GENERATE ID"; }, 5000);
            } catch(e) { 
                alert("Error: " + e.message);
                btn.disabled = false;
                btn.innerText = "GENERATE ID";
            }
        }
    </script>
</body>
</html>
